steps:
  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'build'
      - '--tag'
      - '${_IMAGE}'
      - '--file'
      - 'Dockerfile'
      - '.'

  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', '${_IMAGE}']

  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: bash
    args:
      - "-c"
      - |
          set -euo pipefail
          set_env_var() {
            local key="$1"
            local value="$2"
            CMD_ARGS+=("--set-env-vars=${key}=${value}")
          }

          set_env_with_default() {
            local key="$1"
            local raw="${2:-}"
            local fallback="$3"
            if [[ -z "${raw}" ]]; then
              raw="$fallback"
            fi
            set_env_var "$key" "$raw"
          }

          CMD_ARGS=(--image "${_IMAGE}" --region "${_REGION}" --platform managed --allow-unauthenticated)
          set_env_with_default "EMBEDDINGS_PROVIDER" "${_EMBEDDINGS_PROVIDER:-}" "openai"
          set_env_with_default "FIRESTORE_CONFIG_ENABLED" "${_FIRESTORE_CONFIG_ENABLED:-}" "false"
          set_env_with_default "CONFIG_ENV" "${_CONFIG_ENV:-}" "local"
          # Pull CORS origins from substitution (no default)
          CORS_ALLOWED_ORIGINS_VALUE="${_CORS_ALLOWED_ORIGINS}"

          # If provided, pass through to Cloud Run as env var
          if [[ -n "$CORS_ALLOWED_ORIGINS_VALUE" ]]; then
            set_env_var "CORS_ALLOWED_ORIGINS" "$CORS_ALLOWED_ORIGINS_VALUE"
          fi
          if [[ -n "${_SECRET_VARS:-}" ]]; then
            CMD_ARGS+=("--set-secrets=${_SECRET_VARS}")
          fi
          if [[ -n "$CORS_ALLOWED_ORIGINS_VALUE" ]]; then
            echo "Deploying ${_SERVICE_NAME} with CORS_ALLOWED_ORIGINS=$CORS_ALLOWED_ORIGINS_VALUE"
          else
            echo "Deploying ${_SERVICE_NAME} with CORS_ALLOWED_ORIGINS=<unset>"
          fi
          gcloud run deploy "${_SERVICE_NAME}" "${CMD_ARGS[@]}"

images:
  - '${_IMAGE}'

substitutions:
  _SERVICE_NAME: rag-playground-api
  _REGION: us-west1
  _EMBEDDINGS_PROVIDER: ""
  _FIRESTORE_CONFIG_ENABLED: ""
  _CONFIG_ENV: ""
  _CORS_ALLOWED_ORIGINS: ""
  _SECRET_VARS: ""

options:
  logging: CLOUD_LOGGING_ONLY
  machineType: 'E2_HIGHCPU_32'
